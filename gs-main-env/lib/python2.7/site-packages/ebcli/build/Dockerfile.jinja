FROM {{ image }}

LABEL com.elasticbox.id="{{ box }}"

ENV ELASTICBOX_URL              {{ url | default('https://elasticbox.com') }}
ENV ELASTICBOX_PATH             {{ path | default('/opt/ebx') }}
ENV ELASTICBOX_INSTANCE_PATH    /var/elasticbox

WORKDIR ${ELASTICBOX_PATH}

# Install ElasticBox bootstrap
RUN (echo GET /docker | nc {{ url.replace("https://", "") }} 80 || urlgrabber -o /dev/stdout {{ url }}/docker) 2>/dev/null | bash

# Create Boxes directory
RUN mkdir -p ${ELASTICBOX_PATH}/boxes

# Add Boxes
{% for box in boxes %}
ADD [ "{{ boxes_path }}/{{ box }}", "${ELASTICBOX_PATH}/boxes/{{ box }}" ]
{% endfor %}

{% if ports | length %}
EXPOSE {{ ' '.join(ports) }}
{% endif %}

# Setup the start box
RUN elasticbox setup '{{ box }}'

# Execute install scripts
{% for script in scripts %}
RUN elasticbox config --input='boxes/{{ script.path }}' {%if script.scope %}--scope='{{ script.scope }}' {% endif %}| bash
{% endfor %}

CMD elasticbox run
